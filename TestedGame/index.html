<!DOCTYPE html>
<html>

<head>
    <script src="game.js"></script>
    <script src="phaser-arcade-physics.min.js"></script>
</head>

<body>

<script>

    const config = {
        type: Phaser.AUTO,
        width: 1400,
        height: 734.5,
        time: {
            desiredFPS: 60
        },
        physics: {
            default: 'arcade',
            arcade: {
                gravity: {y: 250},
                // debug: true,
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    ////////////////////////////////////////////////////////////////////////////////////////

    var game = new Phaser.Game(config);
    var marioX = 250;
    var marioY = 120;
    var cursors;
    var mario;
    var xy;
    var stars;
    var starsN = 0;
    var i = 0;
    var score;
    var backgrounds;
    let worldMove = 0;
    var timer;

    var platforms;
    var platformsN;
    const platformLevels = 2;
    const platformLocations = new Array();
    const platformBodyLocations = new Array();
    var platformBodyHeight = new Array();
    var nextPlatform = 1000;
    var nextPlatformHeight = 1000;

    var noGrounds;
    var noGroundsN;
    var noGroundLocations = new Array();
    var nextNoGround = 2000;

    var movement = true;
    var player = {
        movement: false,
        moveLeft: false,
        moveRight: false,
        jump: false,

    };

    class section {
        constructor(center, end, type) {
            this.center = center;
            this.end = end;
            this.type = type;
            if (type == "platform" || type == "empty") {
                this.start = center - 75;
            } else if (type == "noGround") {
                this.start = center - 98;
            }
            this.carried;
        }
    }

    var sections = new Array();
    var totalSections;
    var sectionsEnd = 542;
    var sectionsStep = 256.4;
    var tempNoGroundsN = 0;
    var tempPlatformsN = 0;
    var nextSection = 500;

    var obstacles;
    var obstaclesN = 0;

    var largeHills;
    var smallHills;
    var largeHillsN = 20;
    var smallHillsN = 20;

    var marioPlatformCollision;
    var mainAudio;
    var gameOverAudio;
    var jumpAudio;
    var coinAudio;
    var winAudio;

    var smallClouds;
    var midClouds;
    var largeClouds;
    var totalClouds = 20;

    var castle;

    var oneTimeUpdateFlag = true;

    /////////////////////////////////////////////////////////////////////////////////////////

    function preload() {

        this.load.image('marioFrames', 'assets/marioFrames.png');

        this.load.image('sky', 'assets/overworld_bg.png');
        this.load.image('mario', 'assets/super_mario.png');
        // this.load.image('mario', 'assets/Mario - Walk1.png');
        this.load.image('platform', 'assets/platform.png');
        this.load.image('castle', 'assets/castle.png');
        this.load.image('star', 'assets/star.png');
        this.load.image('noGround', 'assets/noGround.png');
        this.load.image('obstacle', 'assets/Piranha Plant.png');
        this.load.image('smallHill', 'assets/Hill - Small.png');
        this.load.image('largeHill', 'assets/Hill - Large.png');
        this.load.image('smallCloud', 'assets/Cloud - Single.png');
        this.load.image('midCloud', 'assets/Cloud - Double.png');
        this.load.image('largeCloud', 'assets/Cloud - Triple.png');
        this.load.audio('mainAudio', 'assets/mainAudio.mp3', {
            instances: 1
        });
        this.load.audio('gameOverAudio', 'assets/gameOver.mp3', {
            instances: 1
        });
        this.load.audio('coinAudio', 'assets/coin.mp3', {
            instances: 1
        });
        this.load.audio('jumpAudio', 'assets/jump.mp3', {
            instances: 1
        });
        this.load.audio('winAudio', 'assets/win.mp3', {
            instances: 1
        });


    }

    function create() {

        this.physics.world.setBounds(-10000, 0, 20000, 615);

        mainAudio = this.sound.add('mainAudio', {
            volume: 3,
            loop: true,
        });

        winAudio = this.sound.add('winAudio', {
            volume: 3,
            loop: false,
        });

        gameOverAudio = this.sound.add('gameOverAudio');

        jumpAudio = this.sound.add('jumpAudio', {
            volume: 1,
        });

        coinAudio = this.sound.add('coinAudio', {
            volume: 1,
        });

        mainAudio.play();

        // var timedEvent = this.time.delayedCall(3000,onEvent, [], this);

        mario = this.physics.add.sprite(marioX, marioY, 'mario');

        castle = this.physics.add.sprite(sectionsEnd + 400, 100, 'castle');

        noGrounds = this.physics.add.staticGroup();

        obstacles = this.physics.add.group();

        largeHills = this.physics.add.group();

        smallHills = this.physics.add.group();

        smallClouds = this.physics.add.staticGroup();

        midClouds = this.physics.add.staticGroup();

        largeClouds = this.physics.add.staticGroup();

        backgrounds = this.add.group({
            key: 'sky',
            repeat: 50,
            setXY: {
                x: -1000,
                y: 350,
                stepX: 577
            }
        });

        platforms = this.physics.add.staticGroup();

        stars = this.physics.add.group();

        generateSections();
        generatePlatforms();
        generateMario();
        generateStarsAndObstacles();
        generateBackground();
        generateNoGrounds();
        generateHills();
        generateClouds();
        generateCastle();

        // this.physics.add.collider(mario, platforms);
        marioPlatformCollision = this.physics.add.collider(mario, platforms);
        this.physics.add.collider(stars, platforms);
        this.physics.add.collider(obstacles, platforms);
        this.physics.add.overlap(mario, stars, collectStar, null, this);
        this.physics.add.overlap(mario, noGrounds, fall, null, this);
        this.physics.add.overlap(mario, obstacles, fall, null, this);


        cursors = this.input.keyboard.createCursorKeys();
        xy = this.add.text(16, 16, '', {fontSize: '32px', fill: '#ffffff'});
        score = this.add.text(1200, 16, '', {fontSize: '32px', fill: '#ffffff'});

    }

    function onEvent() {
        player.jump = true;
    }

    function update() {

        play();

        if (oneTimeUpdateFlag) {

            castle.x = sectionsEnd + 400;
            castle.y = 100;

            oneTimeUpdateFlag = false;
        }

        xy.setText('X:' + this.input.mousePointer.x + "  Y:" + this.input.mousePointer.y, {
            fontSize: '32px',
            fill: '#ffffff'
        });

        score.setText('Score: ' + i, {
            fontSize: '32px',
            fill: '#ffffff'
        });

        marioY = mario.body.y;

        if (movement) {

            if (cursors.left.isDown) {
                mario.move("left");
                if (worldMove > 0)
                    worldMove--;
            }
            if (cursors.right.isDown) {
                mario.move("right");
                worldMove++;
            }
            if (cursors.up.isDown && mario.body.onFloor()) {
                mario.move("up");
                cursors.up.isDown = false;
                player.jump = false;
            }

            if (player.jump) {
                cursors.up.isDown = true;
                nextSection = 1000;
            }

            if (player.moveLeft) {
                cursors.left.isDown = true;
            }

            if (player.moveRight) {
                cursors.right.isDown = true;
            }

        }

    }

    function collectStar(mario, star) {
        console.log("HHHHHH");
        star.disableBody(true, true);
        i++;
        coinAudio.play();
    }

    function fall(mario, noGround) {
        // player.jump = true;
        mario.body.collideWorldBounds = false;
        movement = false;
        this.physics.world.removeCollider(marioPlatformCollision);
        mainAudio.stop();
        gameOverAudio.play();

    }

    /////////////////// Generate Functions //////////////////////////////


    function generateSections() {

        platformsN = Phaser.Math.Between(10, 15);
        // platformsN = 5;
        noGroundsN = Phaser.Math.Between(3, 5);
        // noGroundsN = 4;
        totalSections = platformsN + noGroundsN;

        for (var i = 0; i < totalSections; i++) {
            var type = Phaser.Math.Between(0, 1);
            if (type == 0 && tempPlatformsN < platformsN || tempNoGroundsN == noGroundsN) {

                sections.push(new section(sectionsEnd, sectionsEnd + sectionsStep, "platform"));
                tempPlatformsN++;
            } else if (tempNoGroundsN < noGroundsN || tempPlatformsN == platformsN) {
                totalSections += 2;
                i += 2;
                sections.push(new section(sectionsEnd, sectionsEnd + sectionsStep, "empty"));
                sectionsEnd += sectionsStep;
                sections.push(new section(sectionsEnd, sectionsEnd + sectionsStep, "noGround"));
                sectionsEnd += sectionsStep;
                sections.push(new section(sectionsEnd, sectionsEnd + sectionsStep, "empty"));
                tempNoGroundsN++;
            }
            sectionsEnd += sectionsStep;

            if (i == totalSections) {
                // castle.x = sectionsEnd + 400;
                // castle.y = 300;
            }
        }

        console.log("PlatformsN: " + platformsN);
        console.log("noGroundsN: " + noGroundsN);

    }

    function generateHills() {

        for (var i = 0; i < totalSections; i++) {
            if (sections[i].type == "empty" || sections[i].type == "platform") {
                var hillX = sections[i].center;
                var hillY = 520;
                var sHill = Phaser.Math.Between(0, 3);
                var lHill = Phaser.Math.Between(0, 3);
                if (sHill == 0) {
                    smallHills.create(hillX + 30, hillY, 'smallHill');
                }
                if (lHill == 0) {
                    largeHills.create(hillX - 30, hillY, 'largeHill');
                }

            }

        }

        smallHills.children.each(function (smallHill) {
            smallHill.body.collideWorldBounds = true;
            smallHill.setDepth(0);
            // smallHill.setScale(2);
        });
        largeHills.children.each(function (largeHill) {
            largeHill.body.collideWorldBounds = true;
            // largeHill.setScale(2);
            largeHill.setDepth(0);
        });

    }

    function generateCastle() {

        castle.body.collideWorldBounds = true;

        castle.setDepth(2);

    }

    function generateClouds() {

        for (var i = 0; i < totalSections; i++) {
            var randomX = Phaser.Math.Between(0, 2);
            var randomY = Phaser.Math.Between(0, 2);
            var randomCloud = Phaser.Math.Between(0, 2);
            var x;
            var y;
            if (randomX == 0)
                x = sections[i].center;
            else if (randomX == 1)
                x = sections[i].center + 50;
            else
                x = sections[i].center + 100;

            if (randomY == 0)
                y = 100;
            else if (randomY == 1)
                y = 150;
            else
                y = 200;

            if (randomCloud == 0)
                smallClouds.create(x, y, 'smallCloud');
            else if (randomCloud == 1)
                midClouds.create(x, y, 'midCloud');
            else
                largeClouds.create(x, y, 'largeCloud');
        }

    }

    function generateNoGrounds() {

        for (var i = 0; i < sections.length; i++) {
            if (sections[i].type == "noGround") {
                var x = sections[i].center;
                noGroundLocations[i] = x - 103.8;
                var y = 688;
                noGrounds.create(x, y, 'noGround');
            }
        }

        noGrounds.children.each(function (noGround) {
            noGround.setSize(82, 120);
            noGround.setScale(0.96);
            noGround.body.x += 60;
            noGround.setDepth(2);
        });

    }

    function generatePlatforms() {

        for (var i = 0; i < totalSections; i++) {
            if (sections[i].type == "platform") {
                var x = sections[i].center - 33.75;
                var y = 480 - 160 * Phaser.Math.Between(0, platformLevels - 1);
                platformBodyHeight.push(y);
                platformLocations.push(x);
                // console.log(x);
                platformLocations.push(y);
                platforms.create(x, y, 'platform');
            }
        }

        platforms.children.each(function (platform) {
            platform.setScale(1.9);
            platform.body.setSize(150, 60);
            platform.setDisplayOrigin(22, 9);
            platform.setDepth(1);
            platformBodyLocations.push(platform.body.x);
        });

    }

    function generateBackground() {
        backgrounds.children.each(function (background) {
            background.setScale(2);
            background.setDepth(0);
        });
    }

    function generateStarsAndObstacles() {


        for (var i = 0; i < platformsN; i++) {

            var x = platformLocations[i * 2] + 35;
            var flag = (Phaser.Math.Between(0, 1) == 0) ? true : false;
            for (var j = 0; j < totalSections; j++) {
                if (sections[j].center > x - 50 || sections[j].center < x + 50) {
                    if (flag) sections[j].carried = "star";
                    else sections[j].carried = "obstacle";
                }
            }

            var y = (Phaser.Math.Between(0, 1) == 0) ? platformLocations[i * 2 + 1] - 100 : 700;
            // var yy = 700;
            if (flag) {
                // console.log("xx: " + xx);
                stars.create(x, y, 'star');
                starsN++;
            } else {
                // console.log("xx: " + xx);
                obstacles.create(x, y, 'obstacle');
                obstaclesN++;
            }
            // console.log("X: " + x + "Y: " + y);

        }
        console.log("STARS: " + starsN);
        console.log("OBSTACLES: " + obstaclesN);

        obstacles.children.each(function (obstacle) {
            obstacle.body.collideWorldBounds = true;
            obstacle.setDepth(1);
        });

        stars.children.each(function (star) {
            star.setScale(0.08);
            star.body.collideWorldBounds = true;
            star.setDepth(1);
        });

    }

    function generateMario() {

        // mario.setSize(210, 250);
        // mario.setScale(2);
        mario.setScale(0.28);
        mario.body.gravity.y = 2000;
        mario.body.bounce.y = 0.1;
        mario.body.collideWorldBounds = true;
        mario.body.checkCollision.right = true;
        mario.setDepth(3);


        mario.move = function (direction) {
            if (direction == "right") {

                // castle = this.physics.add.sprite(sectionsEnd + 400,100,'castle');

                if (marioX > castle.x) {
                    movement = false;
                    mainAudio.stop();
                    winAudio.play();

                }

                if (worldMove > 0) {
                    platforms.children.each(function (platform) {
                        platform.body.x -= 5;
                        platform.x -= 5;
                    });
                    for (var i = 0; i < platformBodyLocations.length; i++) {
                        platformBodyLocations[i] -= 5;
                        if (platformBodyLocations[i] > marioX && platformBodyLocations[i] - marioX < nextPlatform) {
                            nextPlatform = platformBodyLocations[i];
                        } else if (nextPlatform < 390) {
                            nextPlatform = 2000;
                        }
                    }

                    stars.children.each(function (star) {
                        star.x -= 5;
                        star.body.x -= 5;
                    });

                    backgrounds.children.each(function (background) {
                        background.x -= 5;
                    });

                    noGrounds.children.each(function (noGround) {
                        noGround.x -= 5;
                        noGround.body.x -= 5;
                    });

                    obstacles.children.each(function (obstacle) {
                        obstacle.x -= 5;
                        obstacle.body.x -= 5;
                        // console.log("OBSTACLE: " + obstacle.x);
                    });

                    smallHills.children.each(function (smallHill) {
                        smallHill.x -= 5;
                        smallHill.body.x -= 5;
                    });

                    largeHills.children.each(function (largeHill) {
                        largeHill.x -= 5;
                        largeHill.body.x -= 5;
                    });

                    smallClouds.children.each(function (smallCloud) {
                        smallCloud.x -= 5;
                        smallCloud.body.x -= 5;
                    });

                    midClouds.children.each(function (midCloud) {
                        midCloud.x -= 5;
                        midCloud.body.x -= 5;
                    });

                    largeClouds.children.each(function (largeCloud) {
                        largeCloud.x -= 5;
                        largeCloud.body.x -= 5;
                    });

                    castle.x -= 5;
                    castle.body.x -= 5;


                    for (var i = 0; i < noGroundLocations.length; i++) {
                        noGroundLocations[i] -= 5;
                        if (noGroundLocations[i] > marioX && noGroundLocations[i] - marioX < nextNoGround) {
                            nextNoGround = noGroundLocations[i];
                        } else if (nextNoGround < 260) {
                            nextNoGround = 2000;
                        }
                    }

                    for (var i = 0; i < sections.length; i++) {
                        sections[i].center -= 5;
                        sections[i].end -= 5;
                        sections[i].start -= 5;
                        if (sections[i].start < nextSection && sections[i].start > 300) {
                            nextSection = sections[i].start;
                        }
                    }

                }
            }

            if (direction == "left") {
                if (worldMove > 0) {
                    platforms.children.each(function (platform) {
                        platform.body.x += 5;
                        platform.x += 5;
                    });
                    for (var i = 0; i < platformBodyLocations.length; i++) {
                        platformBodyLocations[i] += 5;
                        if (platformBodyLocations[i] > marioX && platformBodyLocations[i] - marioX < nextPlatform) {
                            nextPlatform = platformBodyLocations[i];
                        } else if (nextPlatform < 390) {
                            nextPlatform = 1000;
                        }

                    }
                    for (var i = 0; i < sections.length; i++) {
                        sections[i].center += 5;
                        sections[i].end += 5;
                        sections[i].start += 5;
                        if (sections[i].start < nextSection && sections[i].start > marioX) {
                            nextSection = sections[i].start;
                        } else if (nextSection < 300) {
                            nextSection = 550;
                        }
                    }
                    stars.children.each(function (star) {
                        star.x += 5;
                        star.body.x += 5;
                    });

                    backgrounds.children.each(function (background) {
                        background.x += 5;
                    });

                    noGrounds.children.each(function (noGround) {
                        noGround.x += 5;
                        noGround.body.x += 5;
                    });

                    obstacles.children.each(function (obstacle) {
                        obstacle.x += 5;
                        obstacle.body.x += 5;
                    });

                    smallHills.children.each(function (smallHill) {
                        smallHill.x += 5;
                        smallHill.body.x += 5;
                    });

                    largeHills.children.each(function (largeHill) {
                        largeHill.x += 5;
                        largeHill.body.x += 5;
                    });

                    smallClouds.children.each(function (smallCloud) {
                        smallCloud.x += 5;
                        smallCloud.body.x += 5;
                    });

                    midClouds.children.each(function (midCloud) {
                        midCloud.x += 5;
                        midCloud.body.x += 5;
                    });

                    largeClouds.children.each(function (largeCloud) {
                        largeCloud.x += 5;
                        largeCloud.body.x += 5;
                    });

                    castle.x += 5;
                    castle.body.x += 5;

                }
            }

            if (direction == "up") {
                // this.time.addEvent({
                //     delay: 500,
                //     callback: ()=>{
                //         // spawn a new apple
                //     },
                //     loop: true
                // });
                this.body.velocity.y = -900;
                jumpAudio.play();
            }
        };

    }

    ////////////////////////////////////////     GAME FUNCTIONS      //////////////////////////////////////////////////////

    function play() {

    }


</script>

</body>
</html>