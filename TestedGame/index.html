<!DOCTYPE html>
<html>
<head>
    <script src="game.js"></script>
    <script src="phaser-arcade-physics.min.js"></script>

</head>
<body>

<script>

    // import * as scene from "./phaser-arcade-physics.min";

    var config = {
        type: Phaser.AUTO,
        width: 1400,
        height: 734.5,
        time: {
            desiredFPS: 60
        },
        physics: {
            default: 'arcade',
            arcade: {
                gravity: {y: 250},
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    ////////////////////////////////////////////////////////////////////////////////////////

    var game = new Phaser.Game(config);
    var marioX = 250;
    var marioY = 120;
    var cursors;
    var mario;
    var xy;
    var stars;
    var i = 0;
    var score;
    var y;
    var backgrounds;
    var worldMove = 0;
    var timer;

    var platforms;
    var platformsN = 8;
    var platformLevels = 2;
    var platformLocations = new Array();
    var platformBodyLocations = new Array();

    var noGrounds;

    var movement = true;
    var player = {
        movement: false,
        moveLeft: false,
        moveRight: false,
        jump: false,
    };
    var nextPlatform = 1000;

    /////////////////////////////////////////////////////////////////////////////////////////

    function preload() {

        this.load.image('sky', 'assets/overworld_bg.png');
        this.load.image('mario', 'assets/super_mario.png');
        this.load.image('platform', 'assets/platform.png');
        this.load.image('star', 'assets/star.png');
        this.load.image('noGround', 'assets/noGround.png');

    }

    function create() {

        this.physics.world.setBounds(-2000, 0, 6000, 613);

        mario = this.physics.add.sprite(marioX, marioY, 'mario');

        noGrounds = this.physics.add.staticGroup();

        for (var i = 0; i < 2; i++) {
            var x = 990.5 + (64.1) * 13 + (64.1 * 25) * i;
            var y = 688;
            noGrounds.create(x, y, 'noGround');
        }

        noGrounds.children.each(function (noGround) {
            noGround.setSize(82, 120);
            noGround.setScale(0.96);
            noGround.body.x += 60;
            // noGround.body.y = 612;
            noGround.setDepth(2);
        });


        backgrounds = this.add.group({
            key: 'sky',
            repeat: 50,
            setXY: {
                x: -1000,
                y: 350,
                stepX: 577
            }
        });


        platforms = this.physics.add.staticGroup();


        stars = this.physics.add.group();


        generatePlatform();
        generateMario();
        generateStar();
        generateBackground();


        this.physics.add.collider(mario, platforms);
        this.physics.add.collider(stars, platforms);
        this.physics.add.overlap(mario, stars, collectStar, null, this);
        this.physics.add.overlap(mario, noGrounds, fall, null, this);

        cursors = this.input.keyboard.createCursorKeys();
        xy = this.add.text(16, 16, '', {fontSize: '32px', fill: '#ffffff'});
        score = this.add.text(1200, 16, '', {fontSize: '32px', fill: '#ffffff'});

    }


    function update(time) {

        play();


        xy.setText('X:' + this.input.mousePointer.x + "  Y:" + time, {
            fontSize: '32px',
            fill: '#ffffff'
        });

        score.setText('Score: ' + i, {
            fontSize: '32px',
            fill: '#ffffff'
        });


        stars.children.each(function (star) {
            // star.setScale(0.12);
            if (star.collideLeft) {
                // console.log("LEFT");
            }
            // star.body.checkCollision.left = true;
        });

        if (movement) {

            if (cursors.left.isDown) {
                mario.move("left");
                if (worldMove > 0)
                    worldMove--;
            }
            if (cursors.right.isDown) {
                mario.move("right");
                worldMove++;
                // time.reset();
            }
            if (cursors.up.isDown && mario.body.onFloor()) {
                mario.move("up");
            }

            if (player.jump) {
                cursors.up.isDown = true;
                timer = time;
            }

            if (player.moveLeft) {
                cursors.left.isDown = true;
            }

            if (player.moveRight) {
                cursors.right.isDown = true;
            }
            if(time - 2000 > timer){
                console.log("TIMER OFF");
                cursors.up.isDown = false;
                timer = 0;
            }

        }


    }


    function collectStar(mario, star) {
        star.disableBody(true, true);
        i++;
    }

    function fall(mario, noGround) {
        // console.log("TOUCH!");
        mario.body.collideWorldBounds = false;
        movement = false;
    }


    /////////////////// Generate Functions //////////////////////////////


    function generatePlatform() {


        for (var i = 0; i < platformsN; i++) {
            if (i < 4) {
                var x = 600 + 256.4 * i;
            } else {
                var x = 600 + 384.6 + 64.1 * 2 + 256.4 * i;
            }
            var y = 480 - 80 * Phaser.Math.Between(0, platformLevels - 1);
            platformLocations[i * 2] = x;
            platformLocations[i * 2 + 1] = y;
            platforms.create(x, y, 'platform');
        }
        // console.log(platformLocations.length);

        platforms.children.each(function (platform) {
            platform.setScale(1.9);
            platform.body.setSize(150, 60);
            platform.setDisplayOrigin(22, 9);
            platform.setDepth(1);
            platformBodyLocations.push(platform.body.x);
        });

    }

    function generateBackground() {
        backgrounds.children.each(function (background) {
            background.setScale(2);
            background.setDepth(0);
        });
    }

    function generateStar() {
        var starsN = platformsN;
        for (var i = 0; i < starsN; i++) {
            var x = platformLocations[i * 2] + 35;
            var y = (Phaser.Math.Between(0, 1) == 0) ? platformLocations[i * 2 + 1] - 50 : 750;
            stars.create(x, y, 'star');
        }


        stars.children.each(function (star) {
            star.setScale(0.08);
            star.body.collideWorldBounds = true;
        });

    }

    function generateMario() {

        mario.setSize(210, 250);
        mario.setScale(0.28);
        mario.body.gravity.y = 2000;
        mario.body.bounce.y = 0.1;
        mario.body.collideWorldBounds = true;
        mario.body.checkCollision.right = true;
        mario.setDepth(3);


        mario.move = function (direction) {
            if (direction == "right") {
                // player.jump = false;
                if (worldMove > 0) {
                    platforms.children.each(function (platform) {
                        platform.body.x -= 5;
                        platform.x -= 5;

                    });
                    for (var i = 0; i < platformBodyLocations.length; i++) {
                        platformBodyLocations[i] -= 5;
                        if (platformBodyLocations[i] > marioX && platformBodyLocations[i] - marioX < nextPlatform){
                            nextPlatform = platformBodyLocations[i];
                        } else if(nextPlatform < 255){
                            nextPlatform = 1000;
                        }

                    }
                    stars.children.each(function (star) {
                        star.x -= 5;
                        star.body.x -= 5;
                    });
                    backgrounds.children.each(function (background) {
                        background.x -= 5;
                    });

                    noGrounds.children.each(function (noGround) {
                        noGround.x -= 5;
                        noGround.body.x -= 5;
                    });
                }
            }

            if (direction == "left") {
                if (worldMove > 0) {
                    platforms.children.each(function (platform) {
                        platform.body.x += 5;
                        platform.x += 5;
                    });
                    for (var i = 0; i < platformBodyLocations.length; i++) {
                        platformBodyLocations[i] += 5;
                        if (platformBodyLocations[i] > marioX && platformBodyLocations[i] - marioX < nextPlatform) {
                            nextPlatform = platformBodyLocations[i];
                        } else if(nextPlatform < 255){
                            nextPlatform = 1000;
                        }

                    }
                    stars.children.each(function (star) {
                        star.x += 5;
                        star.body.x += 5;
                    });

                    backgrounds.children.each(function (background) {
                        background.x += 5;
                        // background.body.x -= 5;
                    });
                    noGrounds.children.each(function (noGround) {
                        noGround.x += 5;
                        noGround.body.x += 5;
                    });
                }
            }

            // console.log(nextPlatform);

            if (direction == "up") {
                this.body.velocity.y = -900;
            }
        };

    }


    ////////////////////////////////////////     GAME FUNCTIONS      //////////////////////////////////////////////////////


    function play() {

        // player.moveRight = true;
        if (nextPlatform < 260) {
            player.jump = true;
            
            console.log("JUMP!");
        }

    }


</script>

</body>
</html>